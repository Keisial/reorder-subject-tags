#!/bin/sh

set -eu

PRIMARY="$1"
SECONDARY="$2"

sed '0,/^\r\?$/ { /^Subject:/I {
	:a; $!N;s/\n[ \t]\+/ /;ta
	/\(\[\|=5[Bb]\)'"$SECONDARY[ _]\+\(#\|=23\)"'[0-9]*\(\]\|=5[Dd]\)/ {
		/\(\[\|=5[Bb]\)'"$PRIMARY[ _]\+\(#\|=23\)"'[0-9]*\(\]\|=5[Dd]\)/! {
			s/:/: ['"$PRIMARY"' #0]/
		}
		/\(\[\|=5[Bb]\)'"$PRIMARY[ _]\+\(#\|=23\)"'[0-9]*\(\]\|=5[Dd]\)/ {
			'"s/\(\(\[\|=5[Bb]\)$SECONDARY[ _]\+\(#\|=23\)[0-9]*\(\]\|=5[Dd]\)\)\(.*\?\)\(\(\[\|=5[Bb]\)$PRIMARY[ _]\+\(#\|=23\)[0-9]*\(\]\|=5[Dd]\)\)/\6\5\1/"'
		}
	}
	P;D;
 } }'
